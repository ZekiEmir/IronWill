@model IEnumerable<IronWill.Models.Project>

@{
    ViewData["Title"] = "Operasyonlar (İş)";
}

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h1 class="display-5 fw-bold text-info"><i class="fas fa-briefcase me-3"></i>OPERASYONLAR</h1>
            <p class="lead text-muted">"Para değil, özgürlük biriktir."</p>
        </div>
        <a asp-action="Create" class="btn btn-outline-info fw-bold">
            <i class="fas fa-plus"></i> YENİ PROJE
        </a>
    </div>
</div>

<!-- FINANCIAL INTEL ROW -->
<div class="row g-4 mb-4">
    <!-- CHART CARD -->
    <div class="col-md-4">
        <div class="card bg-card border border-info shadow-lg h-100">
            <div class="card-header border-bottom border-info">
                <span class="text-info fw-bold"><i class="fas fa-chart-pie me-2"></i> GELİR DAĞILIMI</span>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- STATS CARDS -->
    <div class="col-md-8">
        <div class="row g-4 h-100">
            <!-- TOTAL CONTRACT -->
            <div class="col-md-6">
                <div class="card bg-card border border-secondary h-100">
                    <div class="card-body d-flex flex-column justify-content-center text-center">
                        <small class="text-muted text-uppercase mb-2">TOPLAM ANLAŞMA</small>
                        <h2 class="display-6 fw-bold text-white">₺@(((decimal)ViewBag.TotalContract).ToString("N0"))</h2>
                    </div>
                </div>
            </div>
             <!-- RECEIVED -->
            <div class="col-md-6">
                <div class="card bg-card border border-success h-100">
                    <div class="card-body d-flex flex-column justify-content-center text-center">
                        <small class="text-success text-uppercase mb-2">TAHSİL EDİLEN</small>
                        <h2 class="display-6 fw-bold text-success">₺@(((decimal)ViewBag.TotalReceived).ToString("N0"))</h2>
                    </div>
                </div>
            </div>
            <!-- PENDING -->
            <div class="col-md-12">
                 <div class="card bg-card border border-warning h-100" style="min-height: 120px;">
                    <div class="card-body d-flex align-items-center justify-content-between px-5">
                        <div class="text-start">
                             <h6 class="text-warning text-uppercase mb-1">BEKLEYEN BAKİYE</h6>
                             <small class="text-muted">Tahsilat bekleyen tutar</small>
                        </div>
                        <h1 class="display-4 fw-bold text-warning mb-0">₺@(((decimal)ViewBag.TotalPending).ToString("N0"))</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PROJECT TABLE -->
<div class="card bg-card border border-secondary shadow-lg">
    <div class="card-header border-secondary bg-dark bg-opacity-50">
        <span class="text-muted fw-bold"><i class="fas fa-list me-2"></i> AKTİF OPERASYONLAR</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0 align-middle">
                <thead>
                    <tr class="text-uppercase small text-muted">
                        <th class="ps-4">Proje</th>
                        <th>Müşteri</th>
                        <th>Durum</th>
                        <th>Bitiş</th>
                        <th class="text-end pe-4">Finans</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model) {
                        var pending = item.ContractAmount - item.PaidAmount;
                        <tr>
                            <td class="ps-4 fw-bold text-white">@item.ProjectName</td>
                            <td class="text-info">@item.ClientName</td>
                            <td>
                                @if(item.Status == "Active") { <span class="badge bg-success text-dark">AKTİF</span> }
                                else if(item.Status == "Completed") { <span class="badge bg-secondary">TAMAMLANDI</span> }
                                else { <span class="badge bg-warning text-dark">@item.Status</span> }
                            </td>
                            <td class="small text-white-50">@item.Deadline.ToString("dd MMM yyyy")</td>
                            <td class="text-end pe-4">
                                <div class="d-flex flex-column">
                                    <span class="text-white fw-bold">₺@item.PaidAmount.ToString("N0")</span>
                                    @if(pending > 0) {
                                        <small class="text-warning" style="font-size: 0.7rem;">(Kalan: ₺@pending.ToString("N0"))</small>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById('incomeChart').getContext('2d');
        const labels = @Html.Raw(Json.Serialize(ViewBag.ChartLabels));
        const data = @Html.Raw(Json.Serialize(ViewBag.ChartValues));

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#0dcaf0', // Info (Blue)
                        '#39ff14', // Neon Green
                        '#ffd700', // Gold
                        '#ff4444'  // Red
                    ],
                    borderColor: '#1f2937',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: { color: '#e0e0e0', boxWidth: 12 }
                    }
                }
            }
        });
    });
</script>
